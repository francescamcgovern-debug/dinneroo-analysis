<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinneroo Unified Analysis Dashboard</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --bg-deep: #06070a;
            --bg-primary: #0c0e14;
            --bg-secondary: #141820;
            --bg-card: #1a1f2e;
            --bg-hover: #232a3d;
            --accent-teal: #00e5c7;
            --accent-purple: #8b5cf6;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
            --accent-blue: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #2d3548;
            --success: #22c55e;
            --warning: #eab308;
            --error: #ef4444;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Navigation */
        .nav {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
        }
        
        .nav-brand {
            padding: 16px 24px;
            border-right: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .nav-brand h1 {
            font-size: 18px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--text-primary), var(--accent-teal));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-tabs {
            display: flex;
            list-style: none;
            flex: 1;
        }
        
        .nav-tabs li a {
            display: block;
            padding: 18px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .nav-tabs li a:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .nav-tabs li a.active {
            color: var(--accent-teal);
            border-bottom-color: var(--accent-teal);
        }
        
        /* Main content */
        .main {
            max-width: 1800px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        
        .card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Stats grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border-left: 3px solid var(--accent-teal);
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .stat-source {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
            font-style: italic;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background: var(--bg-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }
        
        tr:hover {
            background: var(--bg-hover);
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .badge-must-have { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge-nice-to-have { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .badge-monitor { background: rgba(100, 116, 139, 0.2); color: #94a3b8; }
        
        .badge-validated { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge-corroborated { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge-single { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        
        .badge-mvp { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .badge-not-mvp { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        
        .badge-high { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .badge-medium { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .badge-low { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        
        /* Filters */
        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .filter-group label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .filter-group select, .filter-group input {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
        }
        
        /* Evidence box */
        .evidence-box {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            border-left: 3px solid var(--accent-blue);
        }
        
        .evidence-box .source {
            font-size: 11px;
            color: var(--accent-blue);
            margin-top: 8px;
        }
        
        /* MVP criteria cards */
        .mvp-criteria {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .mvp-card {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .mvp-card .number {
            font-size: 48px;
            font-weight: 700;
            color: var(--accent-teal);
            font-family: 'JetBrains Mono', monospace;
        }
        
        .mvp-card .label {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .mvp-card .evidence {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        
        /* Kids happy indicator */
        .kids-happy {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .kids-happy-bar {
            width: 60px;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
        }
        
        .kids-happy-fill {
            height: 100%;
            background: var(--success);
            border-radius: 3px;
        }
        
        .kids-happy-text {
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }
        
        .kids-happy-n {
            font-size: 10px;
            color: var(--text-muted);
        }
        
        /* Core cuisines */
        .cuisine-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
        }
        
        .cuisine-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .cuisine-card .name {
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: capitalize;
        }
        
        .cuisine-card .metric {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .cuisine-card .metric strong {
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }
        
        /* Quadrant display */
        .quadrant-tag {
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-muted);
        }
        
        .quadrant-high-high { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .quadrant-high-low { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .quadrant-low-high { background: rgba(234, 179, 8, 0.2); color: #eab308; }
        .quadrant-low-low { background: rgba(100, 116, 139, 0.2); color: #64748b; }
        
        /* Loading state */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* Expandable details */
        .expandable {
            cursor: pointer;
        }
        
        .details-row {
            display: none;
            background: var(--bg-secondary);
        }
        
        .details-row.show {
            display: table-row;
        }
        
        .details-content {
            padding: 16px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        .details-section h4 {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .details-item {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            padding: 4px 0;
        }
        
        .details-item .label {
            color: var(--text-secondary);
        }
        
        .details-item .value {
            font-family: 'JetBrains Mono', monospace;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-content">
            <div class="nav-brand">
                <h1>üçΩÔ∏è Dinneroo Analysis</h1>
            </div>
            <ul class="nav-tabs">
                <li><a href="#dishes" class="active" onclick="showTab('dishes')">Priority Dishes</a></li>
                <li><a href="#zones" onclick="showTab('zones')">Zone MVP</a></li>
                <li><a href="#methodology" onclick="showTab('methodology')">Methodology</a></li>
            </ul>
        </div>
    </nav>

    <main class="main">
        <!-- DISHES TAB -->
        <div id="dishes" class="tab-content active">
            <div class="stats-grid" id="dish-stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-dishes">--</div>
                    <div class="stat-label">Total Dishes Analyzed</div>
                </div>
                <div class="stat-card" style="border-color: var(--success);">
                    <div class="stat-value" style="color: var(--success);" id="must-have-count">--</div>
                    <div class="stat-label">Must Have Dishes</div>
                </div>
                <div class="stat-card" style="border-color: var(--accent-blue);">
                    <div class="stat-value" style="color: var(--accent-blue);" id="with-kids-happy">--</div>
                    <div class="stat-label">With Kids Happy Data</div>
                    <div class="stat-source">Source: Post-order survey</div>
                </div>
                <div class="stat-card" style="border-color: var(--accent-purple);">
                    <div class="stat-value" style="color: var(--accent-purple);" id="with-latent-demand">--</div>
                    <div class="stat-label">With Latent Demand</div>
                    <div class="stat-source">Source: Open-text analysis</div>
                </div>
            </div>

            <div class="card">
                <h3>üìä Priority Dishes</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    Dishes ranked by priority score. Includes both dishes on Dinneroo (with performance data) and latent demand opportunities (not yet available).
                    Click a row to see full evidence breakdown.
                </p>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Tier</label>
                        <select id="tier-filter" onchange="renderDishTable()">
                            <option value="all">All Tiers</option>
                            <option value="Must Have">Must Have</option>
                            <option value="Nice to Have">Nice to Have</option>
                            <option value="Monitor">Monitor</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Availability</label>
                        <select id="availability-filter" onchange="renderDishTable()">
                            <option value="all">All</option>
                            <option value="on-dinneroo">On Dinneroo</option>
                            <option value="latent-demand">Latent Demand Only</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Evidence Level</label>
                        <select id="evidence-filter" onchange="renderDishTable()">
                            <option value="all">All Levels</option>
                            <option value="Validated">Validated (3+ sources)</option>
                            <option value="Corroborated">Corroborated (2 sources)</option>
                            <option value="Single">Single Source</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="dish-search" placeholder="Search dishes..." oninput="renderDishTable()">
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Dish</th>
                                <th>Tier</th>
                                <th>Priority</th>
                                <th>Kids Happy</th>
                                <th>On Dinneroo</th>
                                <th>Quadrant</th>
                                <th>Evidence</th>
                            </tr>
                        </thead>
                        <tbody id="dish-tbody">
                            <tr><td colspan="8" class="loading">Loading dishes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ZONES TAB -->
        <div id="zones" class="tab-content">
            <div class="card">
                <h3>üìã MVP Criteria - Selection Requirements</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 20px;">
                    What a zone needs to be considered MVP-ready. Each threshold is validated against consumer outcomes (kids happy, reorder intent, variety complaints).
                </p>
                
                <div class="mvp-criteria" id="mvp-criteria">
                    <div class="mvp-card">
                        <div class="number" id="mvp-cuisines">5</div>
                        <div class="label">Core Cuisines</div>
                        <div class="evidence" id="cuisine-evidence">Loading...</div>
                    </div>
                    <div class="mvp-card">
                        <div class="number" id="mvp-partners">5+</div>
                        <div class="label">Partners</div>
                        <div class="evidence" id="partner-evidence">Loading...</div>
                    </div>
                    <div class="mvp-card">
                        <div class="number">3+</div>
                        <div class="label">Tier 1 Dish Types</div>
                        <div class="evidence">Katsu, Pho, Pizza/Pasta, Curry, Rice Bowls</div>
                    </div>
                </div>
                
                <div class="evidence-box" style="margin-top: 20px;">
                    <strong>üéØ Consumer Outcome Validation</strong>
                    <p style="font-size: 13px; margin-top: 8px; color: var(--text-secondary);">
                        Survey data (n=1,389) joined to zones shows impact on family satisfaction:
                    </p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 12px;" id="consumer-validation">
                        <div class="loading">Loading consumer validation...</div>
                    </div>
                    <div class="source" id="consumer-source" style="margin-top: 12px;"></div>
                </div>
                
                <div class="evidence-box" style="margin-top: 16px;">
                    <strong>üìä Variety Demand</strong>
                    <p style="font-size: 13px; margin-top: 8px;" id="variety-evidence">Loading...</p>
                    <div class="source" id="variety-source"></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üçú Core Cuisines by Performance</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    Top cuisines ranked by repeat rate (families coming back). These are the cuisines every MVP zone should have.
                </p>
                <div class="cuisine-grid" id="cuisine-grid">
                    <div class="loading">Loading cuisines...</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìç Zone Status</h3>
                <div class="stats-grid" id="zone-stats" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value" id="total-zones">--</div>
                        <div class="stat-label">Total Zones</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--success);">
                        <div class="stat-value" style="color: var(--success);" id="mvp-ready">--</div>
                        <div class="stat-label">MVP Ready</div>
                    </div>
                    <div class="stat-card" style="border-color: var(--error);">
                        <div class="stat-value" style="color: var(--error);" id="high-priority">--</div>
                        <div class="stat-label">High Priority Gaps</div>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="zone-status-filter" onchange="renderZoneTable()">
                            <option value="all">All Zones</option>
                            <option value="mvp">MVP Ready</option>
                            <option value="not-mvp">Not MVP</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Priority</label>
                        <select id="zone-priority-filter" onchange="renderZoneTable()">
                            <option value="all">All Priorities</option>
                            <option value="High">High Priority</option>
                            <option value="Medium">Medium Priority</option>
                            <option value="Low">Low Priority</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Zone</th>
                                <th>Orders</th>
                                <th>Partners</th>
                                <th>Cuisines</th>
                                <th>Dishes</th>
                                <th>MVP Status</th>
                                <th>Missing Cuisines</th>
                                <th>Priority</th>
                            </tr>
                        </thead>
                        <tbody id="zone-tbody">
                            <tr><td colspan="8" class="loading">Loading zones...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- METHODOLOGY TAB -->
        <div id="methodology" class="tab-content">
            <div class="card">
                <h3>üìê Data Sources</h3>
                <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
                    This dashboard merges multiple data sources to provide evidence-backed recommendations.
                </p>
                
                <table>
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>What It Contains</th>
                            <th>Sample Size</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Anna's Coverage Matrix</strong></td>
                            <td>Dish importance, coverage, quadrant, action</td>
                            <td>86 dishes</td>
                        </tr>
                        <tr>
                            <td><strong>Track A Performance</strong></td>
                            <td>kids_happy rate, adult_satisfaction, ratings with sample sizes</td>
                            <td>22 dish types measured</td>
                        </tr>
                        <tr>
                            <td><strong>Track B Opportunity</strong></td>
                            <td>Latent demand mentions, 10-factor framework scores</td>
                            <td>48 dish types scored</td>
                        </tr>
                        <tr>
                            <td><strong>Threshold Sensitivity</strong></td>
                            <td>Cuisine/partner count impact on orders and rating</td>
                            <td>197 zones analyzed</td>
                        </tr>
                        <tr>
                            <td><strong>Cuisine Performance</strong></td>
                            <td>Repeat rates and ratings by cuisine</td>
                            <td>~80,000 orders</td>
                        </tr>
                        <tr>
                            <td><strong>Zone Gap Report</strong></td>
                            <td>Per-zone missing cuisines and dish types</td>
                            <td>100 zones</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card">
                <h3>üî¨ Evidence Levels</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>Definition</th>
                            <th>Use For</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><span class="badge badge-validated">üü¢ Validated</span></td>
                            <td>3+ independent sources (e.g., survey + ratings + orders)</td>
                            <td>Strategic recommendations, stakeholder presentations</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-corroborated">üü° Corroborated</span></td>
                            <td>2 independent sources</td>
                            <td>Working hypotheses, internal analysis</td>
                        </tr>
                        <tr>
                            <td><span class="badge badge-single">üîµ Single</span></td>
                            <td>One data source only</td>
                            <td>Exploratory findings, hypothesis generation</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card">
                <h3>‚ö†Ô∏è Survivorship Bias Mitigation</h3>
                <div class="evidence-box">
                    <strong>The Problem:</strong> Order volume only shows what works among AVAILABLE options, not what families WANT.
                    <p style="margin-top: 12px; font-size: 13px;">
                        <strong>Our Solution:</strong> Two-track scoring system:
                    </p>
                    <ul style="margin-top: 8px; margin-left: 20px; font-size: 13px; color: var(--text-secondary);">
                        <li><strong>Track A (Performance):</strong> Measures how well available dishes perform (ratings, kids_happy, satisfaction)</li>
                        <li><strong>Track B (Opportunity):</strong> Scores all dish types including unavailable ones based on latent demand, family fit framework, and partner capability</li>
                    </ul>
                    <p style="margin-top: 12px; font-size: 13px;">
                        This ensures dishes like "Chinese Family Meal" (58 latent demand mentions, not on Dinneroo) appear in recommendations.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global data stores
        let dishData = [];
        let zoneData = [];
        let mvpEvidence = {};
        let consumerValidation = {};
        
        // Tab switching
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tabs a').forEach(link => link.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`a[href="#${tabId}"]`).classList.add('active');
        }
        
        // Load all data
        async function loadAllData() {
            try {
                // Try to fetch from files first
                const [dishResponse, zoneResponse, mvpResponse, consumerResponse] = await Promise.all([
                    fetch('../data/unified_dishes.json'),
                    fetch('../data/zone_gaps.json'),
                    fetch('../data/mvp_evidence.json'),
                    fetch('../data/mvp_consumer_validation.json')
                ]);
                
                if (dishResponse.ok) {
                    dishData = await dishResponse.json();
                }
                if (zoneResponse.ok) {
                    const zoneJson = await zoneResponse.json();
                    zoneData = zoneJson.zones || [];
                }
                if (mvpResponse.ok) {
                    mvpEvidence = await mvpResponse.json();
                }
                if (consumerResponse.ok) {
                    consumerValidation = await consumerResponse.json();
                }
                
                // Render everything
                renderDishStats();
                renderDishTable();
                renderMVPCriteria();
                renderZoneStats();
                renderZoneTable();
                renderCuisineGrid();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dish-tbody').innerHTML = `
                    <tr><td colspan="8" style="text-align: center; color: var(--error); padding: 40px;">
                        Error loading data. Please run the pipeline to generate data files.
                    </td></tr>
                `;
            }
        }
        
        // Render dish stats
        function renderDishStats() {
            document.getElementById('total-dishes').textContent = dishData.length;
            document.getElementById('must-have-count').textContent = dishData.filter(d => d.tier === 'Must Have').length;
            document.getElementById('with-kids-happy').textContent = dishData.filter(d => 
                d.performance && d.performance.kids_happy && d.performance.kids_happy.rate !== null
            ).length;
            document.getElementById('with-latent-demand').textContent = dishData.filter(d => 
                d.opportunity && d.opportunity.latent_demand_mentions > 0
            ).length;
        }
        
        // Render dish table
        function renderDishTable() {
            const tbody = document.getElementById('dish-tbody');
            if (!dishData.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No dish data available</td></tr>';
                return;
            }
            
            // Get filters
            const tierFilter = document.getElementById('tier-filter').value;
            const availFilter = document.getElementById('availability-filter').value;
            const evidenceFilter = document.getElementById('evidence-filter').value;
            const search = document.getElementById('dish-search').value.toLowerCase();
            
            // Filter dishes
            let filtered = dishData.filter(d => {
                if (tierFilter !== 'all' && d.tier !== tierFilter) return false;
                if (availFilter === 'on-dinneroo' && !d.on_dinneroo) return false;
                if (availFilter === 'latent-demand' && d.on_dinneroo) return false;
                if (evidenceFilter !== 'all' && d.evidence_level !== evidenceFilter) return false;
                if (search && !d.dish.toLowerCase().includes(search)) return false;
                return true;
            });
            
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 40px;">No dishes match your filters</td></tr>';
                return;
            }
            
            // Render rows
            tbody.innerHTML = filtered.slice(0, 100).map(dish => {
                // Kids happy display
                let kidsHappyHtml = '-';
                if (dish.performance && dish.performance.kids_happy && dish.performance.kids_happy.rate !== null) {
                    const rate = Math.round(dish.performance.kids_happy.rate * 100);
                    const n = dish.performance.kids_happy.n;
                    kidsHappyHtml = `
                        <div class="kids-happy">
                            <div class="kids-happy-bar"><div class="kids-happy-fill" style="width: ${rate}%"></div></div>
                            <span class="kids-happy-text">${rate}%</span>
                            <span class="kids-happy-n">(n=${n})</span>
                        </div>
                    `;
                }
                
                // Tier badge
                const tierClass = dish.tier === 'Must Have' ? 'badge-must-have' : 
                                  dish.tier === 'Nice to Have' ? 'badge-nice-to-have' : 'badge-monitor';
                
                // Evidence badge
                const evidenceClass = dish.evidence_level === 'Validated' ? 'badge-validated' :
                                      dish.evidence_level === 'Corroborated' ? 'badge-corroborated' : 'badge-single';
                
                // Quadrant class
                let quadrantClass = 'quadrant-tag';
                if (dish.quadrant && dish.quadrant.includes('High Importance') && dish.quadrant.includes('High Coverage')) {
                    quadrantClass += ' quadrant-high-high';
                } else if (dish.quadrant && dish.quadrant.includes('High Importance')) {
                    quadrantClass += ' quadrant-high-low';
                } else if (dish.quadrant && dish.quadrant.includes('High Coverage')) {
                    quadrantClass += ' quadrant-low-high';
                }
                
                return `
                    <tr class="expandable" onclick="toggleDetails(${dish.rank})">
                        <td>${dish.rank}</td>
                        <td>
                            <div style="font-weight: 600;">${dish.dish}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${dish.cuisine}</div>
                        </td>
                        <td><span class="badge ${tierClass}">${dish.tier}</span></td>
                        <td style="font-family: 'JetBrains Mono', monospace;">${dish.priority_score.toFixed(2)}</td>
                        <td>${kidsHappyHtml}</td>
                        <td>${dish.on_dinneroo ? '‚úÖ' : '‚ùå'}</td>
                        <td><span class="${quadrantClass}">${dish.quadrant || '-'}</span></td>
                        <td><span class="badge ${evidenceClass}">${dish.evidence_level}</span></td>
                    </tr>
                    <tr class="details-row" id="details-${dish.rank}">
                        <td colspan="8">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="details-section">
                                        <h4>Performance Data (Track A)</h4>
                                        ${dish.performance ? `
                                            <div class="details-item">
                                                <span class="label">Rating</span>
                                                <span class="value">${dish.performance.rating?.value?.toFixed(2) || '-'} (n=${dish.performance.rating?.n || '-'})</span>
                                            </div>
                                            <div class="details-item">
                                                <span class="label">Kids Happy</span>
                                                <span class="value">${dish.performance.kids_happy?.rate ? (dish.performance.kids_happy.rate * 100).toFixed(0) + '%' : '-'} (n=${dish.performance.kids_happy?.n || '-'})</span>
                                            </div>
                                            <div class="details-item">
                                                <span class="label">Adult Satisfaction</span>
                                                <span class="value">${dish.performance.adult_satisfaction?.rate ? (dish.performance.adult_satisfaction.rate * 100).toFixed(0) + '%' : '-'} (n=${dish.performance.adult_satisfaction?.n || '-'})</span>
                                            </div>
                                            <div class="details-item">
                                                <span class="label">Track A Score</span>
                                                <span class="value">${dish.performance.track_a_score?.toFixed(2) || '-'}</span>
                                            </div>
                                        ` : '<p style="color: var(--text-muted); font-size: 12px;">No performance data (not on Dinneroo or insufficient orders)</p>'}
                                    </div>
                                    <div class="details-section">
                                        <h4>Opportunity Data (Track B)</h4>
                                        ${dish.opportunity ? `
                                            <div class="details-item">
                                                <span class="label">Latent Demand Mentions</span>
                                                <span class="value">${dish.opportunity.latent_demand_mentions || 0}</span>
                                            </div>
                                            <div class="details-item">
                                                <span class="label">Kid Friendly Score</span>
                                                <span class="value">${dish.opportunity.kid_friendly || '-'}/5</span>
                                            </div>
                                            <div class="details-item">
                                                <span class="label">Fussy Eater Friendly</span>
                                                <span class="value">${dish.opportunity.fussy_eater_friendly || '-'}/5</span>
                                            </div>
                                            <div class="details-item">
                                                <span class="label">Framework Score</span>
                                                <span class="value">${dish.opportunity.framework_score?.toFixed(2) || '-'}</span>
                                            </div>
                                        ` : '<p style="color: var(--text-muted); font-size: 12px;">No opportunity data</p>'}
                                    </div>
                                    <div class="details-section">
                                        <h4>Action & Partners</h4>
                                        <div class="details-item">
                                            <span class="label">Action</span>
                                            <span class="value" style="font-family: inherit;">${dish.action || '-'}</span>
                                        </div>
                                        <div class="details-item">
                                            <span class="label">Order Volume</span>
                                            <span class="value">${dish.order_volume?.toLocaleString() || 0}</span>
                                        </div>
                                        <div class="details-item">
                                            <span class="label">Potential Partners</span>
                                            <span class="value" style="font-family: inherit;">${dish.potential_partners || '-'}</span>
                                        </div>
                                        <div class="details-item">
                                            <span class="label">Gap Type</span>
                                            <span class="value" style="font-family: inherit;">${dish.gap_type || '-'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Toggle details row
        function toggleDetails(rank) {
            const row = document.getElementById(`details-${rank}`);
            if (row) {
                row.classList.toggle('show');
            }
        }
        
        // Render MVP criteria
        function renderMVPCriteria() {
            if (!mvpEvidence.cuisine_threshold) return;
            
            // Cuisine evidence
            const ce = mvpEvidence.cuisine_threshold.evidence;
            document.getElementById('cuisine-evidence').innerHTML = `
                ${ce.impact}<br>
                <span style="font-size: 10px; color: var(--text-muted);">
                    5 cuisines: ${ce['5_cuisines'].avg_orders} orders, ${ce['5_cuisines'].avg_rating}‚òÖ (n=${ce['5_cuisines'].zones} zones)<br>
                    4 cuisines: ${ce['4_cuisines'].avg_orders} orders, ${ce['4_cuisines'].avg_rating}‚òÖ (n=${ce['4_cuisines'].zones} zones)
                </span>
            `;
            
            // Partner evidence
            const pe = mvpEvidence.partner_threshold.evidence;
            document.getElementById('partner-evidence').innerHTML = `
                ${pe.impact}<br>
                <span style="font-size: 10px; color: var(--text-muted);">
                    5 partners: ${pe['5_partners'].avg_orders} orders (n=${pe['5_partners'].zones} zones)<br>
                    1-2 partners: ${pe['1-2_partners'].avg_orders} orders (n=${pe['1-2_partners'].zones} zones)
                </span>
            `;
            
            // Variety evidence
            document.getElementById('variety-evidence').textContent = 
                `${mvpEvidence.variety_demand} - families explicitly request more variety in open-text feedback.`;
            document.getElementById('variety-source').textContent = 
                `Source: ${mvpEvidence.variety_source}`;
            
            // Consumer validation (kids happy, reorder intent, variety complaints)
            renderConsumerValidation();
        }
        
        // Render consumer validation section
        function renderConsumerValidation() {
            const container = document.getElementById('consumer-validation');
            if (!consumerValidation.cuisine_impact) {
                container.innerHTML = '<div class="loading">Consumer validation data not available</div>';
                return;
            }
            
            const ci = consumerValidation.cuisine_impact;
            const pi = consumerValidation.partner_impact;
            
            // Get bucket data for comparison
            const low = ci.buckets['3-4_cuisines'] || {};
            const high = ci.buckets['5+_cuisines'] || {};
            
            // Calculate actual differences
            const kidsHappyDiff = high.kids_happy && low.kids_happy ? 
                ((high.kids_happy - low.kids_happy) * 100).toFixed(1) : 'N/A';
            const reorderDiff = high.reorder_intent && low.reorder_intent ? 
                ((high.reorder_intent - low.reorder_intent) * 100).toFixed(1) : 'N/A';
            
            container.innerHTML = `
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; border-left: 3px solid var(--success);">
                    <div style="font-weight: 600; font-size: 14px; color: var(--success);">Kids Full & Happy</div>
                    <div style="font-size: 24px; font-weight: 700; margin: 4px 0;">
                        ${high.kids_happy ? (high.kids_happy * 100).toFixed(1) : '--'}%
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">
                        5+ cuisines (n=${high.kids_happy_n || 0})<br>
                        vs ${low.kids_happy ? (low.kids_happy * 100).toFixed(1) : '--'}% for 3-4 cuisines (n=${low.kids_happy_n || 0})<br>
                        <span style="color: ${kidsHappyDiff > 0 ? 'var(--success)' : 'var(--text-muted)'};">
                            ${kidsHappyDiff > 0 ? '+' : ''}${kidsHappyDiff}pp difference
                        </span>
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; border-left: 3px solid var(--accent-blue);">
                    <div style="font-weight: 600; font-size: 14px; color: var(--accent-blue);">Reorder Intent</div>
                    <div style="font-size: 24px; font-weight: 700; margin: 4px 0;">
                        ${high.reorder_intent ? (high.reorder_intent * 100).toFixed(1) : '--'}%
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">
                        5+ cuisines (n=${high.reorder_intent_n || 0})<br>
                        vs ${low.reorder_intent ? (low.reorder_intent * 100).toFixed(1) : '--'}% for 3-4 cuisines (n=${low.reorder_intent_n || 0})<br>
                        <span style="color: ${reorderDiff > 0 ? 'var(--success)' : 'var(--text-muted)'};">
                            ${reorderDiff > 0 ? '+' : ''}${reorderDiff}pp difference
                        </span>
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; border-left: 3px solid var(--warning);">
                    <div style="font-weight: 600; font-size: 14px; color: var(--warning);">Variety Complaints</div>
                    <div style="font-size: 24px; font-weight: 700; margin: 4px 0;">
                        ${high.variety_complaints ? (high.variety_complaints * 100).toFixed(1) : '--'}%
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">
                        5+ cuisines (n=${high.variety_complaints_n || 0})<br>
                        vs ${low.variety_complaints ? (low.variety_complaints * 100).toFixed(1) : '--'}% for 3-4 cuisines<br>
                        <span style="color: var(--text-muted);">
                            ${((high.variety_complaints - low.variety_complaints) * 100).toFixed(1)}pp difference
                        </span>
                    </div>
                </div>
                <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; border-left: 3px solid var(--accent-purple);">
                    <div style="font-weight: 600; font-size: 14px; color: var(--accent-purple);">Sample Coverage</div>
                    <div style="font-size: 24px; font-weight: 700; margin: 4px 0;">
                        ${ci.summary.sample_size_high}
                    </div>
                    <div style="font-size: 11px; color: var(--text-muted);">
                        Survey responses in 5+ cuisine zones<br>
                        ${ci.summary.sample_size_low} in 1-2 cuisine zones<br>
                        Total: ${Object.values(ci.buckets).reduce((sum, b) => sum + (b.n || 0), 0)} responses
                    </div>
                </div>
            `;
            
            document.getElementById('consumer-source').textContent = 
                `Source: ${consumerValidation.source || 'POST_ORDER_SURVEY joined to zone metrics'}`;
        }
        
        // Render cuisine grid
        function renderCuisineGrid() {
            const grid = document.getElementById('cuisine-grid');
            if (!mvpEvidence.core_cuisines) {
                grid.innerHTML = '<div class="loading">No cuisine data</div>';
                return;
            }
            
            grid.innerHTML = mvpEvidence.core_cuisines.map(c => `
                <div class="cuisine-card">
                    <div class="name">${c.cuisine}</div>
                    <div class="metric">Repeat: <strong>${(c.repeat_rate * 100).toFixed(1)}%</strong></div>
                    <div class="metric">Rating: <strong>${c.rating.toFixed(2)}‚òÖ</strong></div>
                    <div class="metric" style="font-size: 10px; margin-top: 4px;">n=${c.n.toLocaleString()} orders</div>
                </div>
            `).join('');
        }
        
        // Render zone stats
        function renderZoneStats() {
            document.getElementById('total-zones').textContent = zoneData.length;
            document.getElementById('mvp-ready').textContent = zoneData.filter(z => z.is_mvp).length;
            document.getElementById('high-priority').textContent = zoneData.filter(z => z.recruitment_priority === 'High').length;
        }
        
        // Render zone table
        function renderZoneTable() {
            const tbody = document.getElementById('zone-tbody');
            if (!zoneData.length) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No zone data available</td></tr>';
                return;
            }
            
            const statusFilter = document.getElementById('zone-status-filter').value;
            const priorityFilter = document.getElementById('zone-priority-filter').value;
            
            let filtered = zoneData.filter(z => {
                if (statusFilter === 'mvp' && !z.is_mvp) return false;
                if (statusFilter === 'not-mvp' && z.is_mvp) return false;
                if (priorityFilter !== 'all' && z.recruitment_priority !== priorityFilter) return false;
                return true;
            });
            
            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 40px;">No zones match your filters</td></tr>';
                return;
            }
            
            tbody.innerHTML = filtered.slice(0, 100).map(zone => {
                const mvpClass = zone.is_mvp ? 'badge-mvp' : 'badge-not-mvp';
                const priorityClass = zone.recruitment_priority === 'High' ? 'badge-high' : 
                                      zone.recruitment_priority === 'Medium' ? 'badge-medium' : 'badge-low';
                
                return `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${zone.zone}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${zone.region}</div>
                        </td>
                        <td style="font-family: 'JetBrains Mono', monospace;">${zone.orders.toLocaleString()}</td>
                        <td style="font-family: 'JetBrains Mono', monospace;">${zone.partners}</td>
                        <td style="font-family: 'JetBrains Mono', monospace;">${zone.cuisines_count}</td>
                        <td style="font-family: 'JetBrains Mono', monospace;">${zone.unique_dishes || 0}</td>
                        <td><span class="badge ${mvpClass}">${zone.is_mvp ? 'MVP Ready' : 'Not MVP'}</span></td>
                        <td style="font-size: 12px; max-width: 200px;">
                            ${zone.missing_cuisines.length ? zone.missing_cuisines.join(', ') : '-'}
                        </td>
                        <td><span class="badge ${priorityClass}">${zone.recruitment_priority}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>
